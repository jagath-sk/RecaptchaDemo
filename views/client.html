<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>reCAPTCHA Test</title>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 40px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .status-message {
      padding: 15px;
      margin: 20px 0;
      border-radius: 5px;
      font-size: 18px;
      display: none;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background-color: #e2f3f5;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    button {
      background-color: #4285f4;
      color: white;
      border: none;
      padding: 12px 25px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      background-color: #3367d6;
    }
    .unity-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      padding: 10px;
      z-index: 9999;
      text-align: center;
      font-weight: bold;
      display: none;
    }
    .unity-banner.error {
      background-color: #f8d7da;
      color: #721c24;
      border-bottom: 2px solid #f5c6cb;
    }
    .unity-banner.success {
      background-color: #d4edda;
      color: #155724;
      border-bottom: 2px solid #c3e6cb;
    }
  </style>
</head>
<body>
  <div id="unity-banner" class="unity-banner"></div>
  
  <div class="container">
    <h1>Security Verification</h1>
    <div id="status-message" class="status-message info">
      Please complete the reCAPTCHA verification
    </div>
    
    <form id="recap-form">
      <div class="g-recaptcha" data-sitekey="6LeWVYUrAAAAAMCqS-UtbyIzNBa9Z6_wGBM0JxHY"></div>
      <br/>
      <button type="submit">Verify</button>
    </form>
  </div>

  <script>
    // Functions to communicate with Unity
    function unityLog(message) {
      console.log(message);
      try {
        window.location.href = "unity-console-log://" + encodeURIComponent(message);
      } catch (err) {
        console.error("Error sending log to Unity: " + err);
      }
    }

    function unityError(message) {
      console.error(message);
      try {
        window.location.href = "unity-console-error://" + encodeURIComponent(message);
      } catch (err) {
        console.error("Error sending error to Unity: " + err);
        handleUnityError("Failed to send error to Unity: " + err.message);
      }
    }

    function showStatus(message, type) {
      const statusEl = document.getElementById('status-message');
      statusEl.textContent = message;
      statusEl.className = 'status-message ' + type;
      statusEl.style.display = 'block';
    }

    // Unity WebGL Error Handler
    function unityShowBanner(message, type) {
      const banner = document.getElementById('unity-banner');
      banner.textContent = message;
      banner.className = 'unity-banner ' + type;
      banner.style.display = 'block';
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        banner.style.display = 'none';
      }, 5000);
    }

    function handleUnityError(message) {
      console.error("[Unity WebGL Error]", message);
      
      // 1. Show visual error using Unity's banner
      unityShowBanner('Loading Error: ' + message, 'error');
      
      // 2. Try to notify Unity instance (if available)
      try {
        if (window.unityInstance && typeof window.unityInstance.SendMessage === 'function') {
          window.unityInstance.SendMessage('DemoLoginManager', 'OnWebGLError', message);
        }
      } catch (e) {
        console.warn("Could not send error to Unity:", e);
      }
      
      // 3. Also send through WebView if available
      try {
        window.location.href = "unity-webgl-error://" + encodeURIComponent(message);
      } catch (e) {
        console.warn("Could not send WebGL error through WebView:", e);
      }
    }

    function handleUnitySuccess(message) {
      console.log("[Unity WebGL Success]", message);
      
      // Show success banner
      unityShowBanner('Success: ' + message, 'success');
      
      // Try to notify Unity instance
      try {
        if (window.unityInstance && typeof window.unityInstance.SendMessage === 'function') {
          window.unityInstance.SendMessage('DemoLoginManager', 'OnWebGLSuccess', message);
        }
      } catch (e) {
        console.warn("Could not send success to Unity:", e);
      }
    }

    // Initialize page
    window.addEventListener('load', function() {
      unityLog('reCAPTCHA page loaded');
      showStatus('Please complete the reCAPTCHA verification', 'info');
      
      // Check for Unity instance
      if (window.unityInstance) {
        unityLog('Unity WebGL instance detected');
      } else {
        unityLog('Running in WebView mode');
      }
    });

    // Handle global errors
    window.addEventListener('error', function(event) {
      const errorMessage = `JavaScript Error: ${event.message} at ${event.filename}:${event.lineno}`;
      handleUnityError(errorMessage);
    });

    // Handle unhandled promise rejections
    window.addEventListener('unhandledrejection', function(event) {
      const errorMessage = `Unhandled Promise Rejection: ${event.reason}`;
      handleUnityError(errorMessage);
    });

    document.getElementById('recap-form').addEventListener('submit', async e => {
      e.preventDefault();
      const token = grecaptcha.getResponse();
      if (!token) {
        const errorMsg = 'reCAPTCHA not completed';
        unityError(errorMsg);
        showStatus('Please complete the reCAPTCHA', 'error');
        handleUnityError(errorMsg);
        return;
      }

      unityLog('reCAPTCHA token received: ' + token.substring(0, 20) + '...');
      showStatus('Verifying your response...', 'info');

      try {
        unityLog('Sending verification request to backend...');
        const resp = await fetch('https://recaptchademo.onrender.com/verify-recaptcha', {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token })
        });

        const data = await resp.json();
        if (data.success) {
          const successMsg = 'reCAPTCHA verification successful!';
          unityLog('‚úÖ ' + successMsg);
          showStatus('‚úÖ Verification successful! Closing...', 'success');
          handleUnitySuccess(successMsg);
          
          // Send token back to Unity and close WebView immediately
          unityLog('Sending token to Unity and closing WebView...');
          window.location.href = "unity-recaptcha-success://" + token;
        } else {
          const errorMessage = 'reCAPTCHA failed: ' + (data.errorCodes || data.message || 'Unknown error');
          unityError('‚ùå ' + errorMessage);
          showStatus('‚ùå ' + errorMessage, 'error');
          handleUnityError(errorMessage);
          
          // Reset widget for another try
          grecaptcha.reset();
        }
      } catch (err) {
        const errorMessage = 'Network error: ' + err.message;
        unityError('üö® ' + errorMessage);
        showStatus('üö® ' + errorMessage, 'error');
        handleUnityError(errorMessage);
        
        // Reset widget for another try
        grecaptcha.reset();
      }
    });
  </script>
</body>
</html>
